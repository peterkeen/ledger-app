<% @selected_month = params[:month].to_s == "" ? Date.new(Date.today.year, Date.today.month, 1) : Date.parse(params[:month]) %>

<% @months = query do %>
  select
    xtn_month
  from
    accounts_months
  group by
    xtn_month
  order by
    xtn_month desc
<% end %>

<% @income = query do %>
with inc as (
    select
      'Salary (after taxes and retirement)' as account,
      sum(amount) as amount
    from
      ledger
    where
      xtn_month = '<%= @selected_month %>'
      and account = 'Assets:Schwab:Checking'
      and note ~ 'Salary'
    union all
    select
      *
    from (
      select
        account,
        -1 * sum(amount) as amount
      from
        ledger
      where
        account ~ '^Income'
        and account !~ '^Income:Salary'
        and xtn_month = '<%= @selected_month %>'
      group by
        account
      order by
        account
    ) x
  )
  select account as "Account", amount as "Amount" from inc
  union all
  select 'Total' as "Account", sum(amount) as "Amount" from inc
<% end %>

<% @budgeted_expenses = query do %>
with budgeted as (  
  select
      b.account as "Account",
      b.amount as "Budget",
      coalesce(x.amount, 0) as "Spent",
      b.amount - coalesce(x.amount, 0) as "Diff"
  from
  (select * from budget_months where xtn_month = '<%= @selected_month %>' and amount > 0) b
  left outer join (
      select
          xtn_month,
          account,
          sum(amount) as amount
      from
          ledger
      where
          account in (select distinct account from budget_periods)
          and xtn_month = '<%= @selected_month %>'
          and tags !~ 'Reimburseable'
          and tags !~ 'nobudget'
      group by
          xtn_month,
          account
  ) x using (account)
  order by
     b.account
)
select
  *
from
  budgeted
union all
select
  'Total' as "Account",
  sum("Budget") as "Budget",
  sum("Spent") as "Spent",
  sum("Diff") as "Diff"
from
  budgeted
<% end %>

<% @unbudgeted_expenses = query do %>
  with ubexp as (
    select
      account as "Account",
      sum(amount) as "Amount"
    from
      expenses
    where (
        (account not in (select account from budget_months where xtn_month = '<%= @selected_month %>'))
        or
        (account in (select account from budget_months where xtn_month = '<%= @selected_month %>') and tags ~ 'nobudget: true')
      )
      and note !~ 'Salary'
      and xtn_month = '<%= @selected_month %>'
    group by
      account
    order by
      account
  )
  select
    *
  from
    ubexp
  union all
  select
    'Total' as "Account",
    sum("Amount") as "Amount"
  from
    ubexp
<% end %>

<% @funds = query do %>
  with funds as (
    select
      account as "Fund",
      sum(case when xtn_month = '<%= @selected_month %>' then amount else 0 end) as "Amount",
      sum(amount) as "Balance"
    from
      ledger
    where
      account ~ '^Assets:Funds'
      and xtn_month <= '<%= @selected_month %>'
    group by
      account
    having
      round(sum(case when xtn_month = '<%= @selected_month %>' then amount else 0 end)) != 0 or round(sum(amount)) != 0
    order by
      account
  )
  select * from funds
  union all
  select 'Total' as "Fund", sum("Amount") as "Amount", sum("Balance") as "Balance" from funds
<% end %>

<% @balances = query do %>
  select
    account as "Account",
    sum(case when xtn_month <= '<%= @selected_month %>' then amount else 0 end) as "<%= @selected_month %>",
    sum(case when xtn_month <= '<%= @selected_month << 1 %>' then amount else 0 end) as "<%= @selected_month << 1 %>",
    sum(case when xtn_month <= '<%= @selected_month << 2 %>' then amount else 0 end) as "<%= @selected_month << 2 %>",
    sum(case when xtn_month <= '<%= @selected_month << 12 %>' then amount else 0 end) as "<%= @selected_month << 12 %>",
    sum(case when xtn_month <= '<%= @selected_month << 24 %>' then amount else 0 end) as "<%= @selected_month << 24 %>"
  from
    ledger
  where
    account in (
      'Assets:Schwab:Checking',
      'Assets:Amex',
      'Liabilities:Loans:Mazda',
      'Liabilities:Loans:Mortgage',
      'Liabilities:Chase:SP'
    )
  group by
    account
  order by
    account
<% end %>

<div class="page-title">
  <h1>Monthly Snapshot</h1>
</div>
<div class="row">
  <div class="span12">
    <form class="form form-inline">    
      <select name="month" class="input">
        <option value="">Current Month</option>
        <% @months.each do |row| %>
          <option value="<%= row[0].value %>" <%= (@selected_month == row[0].value) ? "selected" : "" %>><%= row[0].value %></option>
        <% end %>
      </select>
      <input type="submit" value="Update" class="btn">
    </form>
  </div>
  <div class="span12">
    <h4>Summary</h4>
    <table class="table table-striped table-hover table-bordered table-condensed">
      <thead>
        <tr>
          <th>Category</th>
          <th><span class="pull-right">Amount</span></th>
        </tr>
      </thead>
      <%
        @income_value = (@income.rows[-1][1].value rescue 0) || 0
        @budgeted_value = (@budgeted_expenses.rows[-1][2].value rescue 0) || 0
        @budgeted_diff = (@budgted_expenses.rows[-1][3].value rescue 0) || 0
        @unbudgeted_value = (@unbudgeted_expenses.rows[-1][1].value rescue 0) || 0
        @funds_value = (@funds.rows[-1][1].value rescue 0) || 0
      %>
      <tbody>
        <tr>
          <td>Income</td>
          <td><span class="pull-right"><%= sprintf("%0.2f", @income_value) %></span></td>
        </tr>
        <tr>
          <td>Budgeted Expenses</td>
          <td><span class="pull-right"><span style="<%= @budgeted_diff > 0 ? 'color: red' : ''%>"><%= sprintf("%0.2f", @budgeted_value) %></span></span></td>
        </tr>
        <tr>
          <td>Unbudgeted Expenses</td>
          <td><span class="pull-right"><span style="<%= @unbudgeted_value > 500 ? 'color: red' : '' %>"><%= sprintf("%0.2f", @unbudgeted_value) %></span></span></td>
        </tr>
        <tr>
          <td>Funds</td>
          <td><span class="pull-right"><%= sprintf("%0.2f", @funds_value) %></span></td>
        </tr>
        <tr>
          <td><strong>Net Cash</strong></td>
          <td><span class="pull-right"><strong><%= sprintf("%0.2f", @income_value - (@budgeted_value + @unbudgeted_value) - @funds_value) %></strong></span></td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="span6">
    <h4>Income</h4>
    <%= @income.error %>
    <%= table @income do |t|
          t.link /Account/ => "/reports/register?account=:0&month=#{@selected_month}", :if => ->(c,r){!(c.text =~ /(Salary|Total)/)}
          t.link /Account/ => "/reports/register?account=Income:Salary&month=#{@selected_month}", :if => ->(c,r){c.text =~ /Salary/}
          t.decorate /.*/ => StyleDecorator.new('font-weight' => 'bold'), :if => ->(c,r){r[0].text == 'Total'}
        end
    %>
  </div>
  <div class="span6">
    <h4>Funds</h4>
    <%= @funds.error %>
    <%= table @funds do |t|
          t.link /Fund/ => "/reports/register?account=:0&month=#{@selected_month}&cleared=", :if => ->(c,r){c.text != "Total"}
          t.decorate /.*/ => StyleDecorator.new('font-weight' => 'bold'), :if => ->(c,r){r[0].text == 'Total'}
          t.decorate /Balance/ => StyleDecorator.new('color' => 'red'), :if => ->(c,r){c.value < 0}
        end
    %>
  </div>
  <div class="span12">
    <h4>Budgeted Expenses</h4>
    <%= @budgeted_expenses.error %>
    <%= table @budgeted_expenses do |t|
          t.decorate /Account/ => ExpensesDecorator.new(month: @selected_month, cleared: '')
          t.decorate /.*/ => StyleDecorator.new('font-weight' => 'bold'), :if => ->(c,r){r[0].text == 'Total'}
          t.decorate /Diff/ => StyleDecorator.new(color: 'red'), :if => lambda { |c,r| c.value < 0 }
        end
    %>
    <h4>Unbudgeted Expenses</h4>
    <%= @unbudgeted_expenses.error %>
    <%= table @unbudgeted_expenses do |t|
          t.decorate /Account/ => ExpensesDecorator.new(month: @selected_month, cleared: '')
          t.decorate /.*/ => StyleDecorator.new('font-weight' => 'bold'), :if => ->(c,r){r[0].text == 'Total'}
          t.decorate /Amount/ => StyleDecorator.new('color' => 'red'), :if => ->(c,r){c.value >= 500 && r[0].text == 'Total'}
          t.decorate /Amount/ => StyleDecorator.new('color' => 'red'), :if => ->(c,r){c.value >= 100 && r[0].text != 'Total'}
        end
    %>
    <h4>Account Balances</h4>
    <%= @balances.error %>
    <%= table @balances %>
  </div>
</div>

<% @expenses = query do %>
  select
      xtn_month as "Month",
      amount as "Amount",
      avg_amount as "Avg. Amount"
  from (
      select
          xtn_month,
          amount,
          avg(amount) over (rows 12 preceding) as avg_amount
      from (
          select
              xtn_month,
              sum(amount) as amount
          from
              ledger
          where
             (
               account ~ '^Expenses'
               and account !~ '(Depreciation|Taxes|Interest|Insurance|Travel|Computers|Medical|Bike|Wedding|Furniture|Stripe|Car|Moving|Sales|House)'
               and tags !~ '(Emergency|Reimbursable)'
             )
             or
             (
               account in ('Expenses:Interest:Mortgage', 'Assets:House:Equity', 'Assets:House:Escrow')
               and tags !~ 'nobudget'
             )          
          group by
              xtn_month
          order by
              xtn_month
      ) x
  ) x
  order by xtn_month desc;
<% end %>
<%= table @expenses do |t|
      t.link /Month/ => '/reports/monthly_expenses_detail?month=:this'
    end %>
